---
const { title, heading, classes, reviews = [] } = Astro.props;
const HeadingLevel = heading || "h2";
import { LuChevronLeft } from "react-icons/lu";
import { LuChevronRight } from "react-icons/lu";
---

<section class=`testimonials ${classes}`>
  {title && <HeadingLevel class="header head-2 h2">{title}</HeadingLevel>}
  <div id="testimonialCarousel" class="carousel">
    <!-- Testimonial items here -->
    <div class="testimonial-wrapper">
      {
        reviews.map((review, index) => {
          // Return JSX elements for each review, using template literals to insert data
          return (
            <div
              class={`testimonial-item *: ${index === 0 ? "active" : ""}`}
              data-index={index}
            >
              <p class="font-cursive font-normal">"{review.text}"</p>
              <cite class="ml-auto">{review.author}</cite>
            </div>
          );
        })
      }
    </div>

    <div class="controls">
      <LuChevronLeft id="prev" className="carousel-btn prev-btn text-black" />
      <!-- Navigation bubbles container -->
      <div class="carousel-nav">
        <span class="nav-dot active" data-slide="0"></span>
        <span class="nav-dot" data-slide="1"></span>
        <span class="nav-dot" data-slide="2"></span>
        <!-- Add more dots as needed -->
      </div>
      <LuChevronRight id="next" className="carousel-btn next-btn text-black" />
    </div>
  </div>
</section>

<script lang="js">
  document.addEventListener("DOMContentLoaded", () => {
    let currentIndex = 0;
    const wrapper = document.querySelector(".testimonial-wrapper");
    const items = document.querySelectorAll(".testimonial-item");
    const dots = document.querySelectorAll(".nav-dot");
    const totalItems = items.length;
    let startX = 0;
    let currentX = 0;
    let moving = false;

    // Function to get the carousel's width
    const getCarouselWidth = () =>
      document.querySelector(".carousel").offsetWidth;

    // Function to update the carousel's position with or without animation
    const setCarouselPosition = (distance, animate = true) => {
      wrapper.style.transition = animate
        ? "transform 0.5s ease-in-out"
        : "none";
      wrapper.style.transform = `translateX(${distance}px)`;
    };

    // Adjusted to support infinite scrolling
    const finalizePosition = () => {
      const movedBy = currentX - startX;
      const threshold = getCarouselWidth() * 0.25; // Swipe threshold is 25% of the carousel width

      if (Math.abs(movedBy) > threshold) {
        if (movedBy < 0) {
          currentIndex = (currentIndex + 1) % totalItems; // Wraps to the first item if next from the last
        } else {
          currentIndex = (currentIndex - 1 + totalItems) % totalItems; // Wraps to the last item if prev from the first
        }
      }

      setCarouselPosition(-currentIndex * getCarouselWidth());
      updateActiveDot();
    };

    // Function to update the active dot
    const updateActiveDot = () => {
      dots.forEach((dot, index) => {
        dot.classList.toggle("active", index === currentIndex);
      });
    };

    // Touch handlers remain the same

    // Move to the next item with wrapping
    const moveNext = () => {
      currentIndex = (currentIndex + 1) % totalItems; // Ensures wrapping to the first item
      setCarouselPosition(-currentIndex * getCarouselWidth());
      updateActiveDot();
    };

    // Move to the previous item with wrapping
    const movePrev = () => {
      currentIndex = (currentIndex - 1 + totalItems) % totalItems; // Ensures wrapping to the last item
      setCarouselPosition(-currentIndex * getCarouselWidth());
      updateActiveDot();
    };

    // Add event listeners for swipe actions
    wrapper.addEventListener("touchstart", (e) => {
      startX = e.touches[0].clientX;
      moving = true;
      wrapper.style.transition = "none";
    });

    wrapper.addEventListener("touchmove", (e) => {
      if (!moving) return;
      currentX = e.touches[0].clientX;
      const moveX = currentX - startX - currentIndex * getCarouselWidth();
      setCarouselPosition(moveX, false);
    });

    wrapper.addEventListener("touchend", () => {
      moving = false;
      finalizePosition();
    });

    // Event listeners for next and prev buttons
    document.getElementById("next").addEventListener("click", moveNext);
    document.getElementById("prev").addEventListener("click", movePrev);

    // Update carousel position on window resize
    window.addEventListener("resize", () => {
      setCarouselPosition(-currentIndex * getCarouselWidth());
    });

    // Navigation dot clicks for direct access to slides
    dots.forEach((dot) => {
      dot.addEventListener("click", (e) => {
        currentIndex = parseInt(dot.getAttribute("data-slide"));
        setCarouselPosition(-currentIndex * getCarouselWidth());
        updateActiveDot();
      });
    });
  });
</script>
<style lang="scss">
  .testimonials {
    padding: 1rem 0;
  }
  .header {
    text-align: center;
    // max-width: 1000px;
    width: calc(100%);
    // padding: 0 5vw;
    margin: 0 auto;
  }
  .carousel {
    width: 100%;
    // max-width: 700px;
    margin: auto;
    overflow: hidden;
    position: relative; /* Ensures child positioning is relative to this container */
  }

  .testimonial-wrapper {
    display: flex;
    transition: transform 0.5s ease-in-out;
  }

  .testimonial-item {
    flex: 0 0 100%;
    text-align: center;
    padding: 20px 5vw;
    box-sizing: border-box;
    /* Ensure each item is tall enough or contains enough content */
    p {
      max-width: 1000px;
      margin: 0 auto;
    }
    @media (max-width: 768px) {
      padding: 5px;

      cite {
        margin: 0 auto;
        display: block;
        max-width: fit-content;
      }
      p {
        max-width: 100%;
        width: calc(100% - 4rem);
      }
    }
  }

  .carousel-btn {
    cursor: pointer;
    font-size: 2rem;
    color: black;
  }

  .controls {
    display: flex;
    align-items: center;
    margin: 0 auto;
    width: fit-content;
  }

  /* Style for the navigation dots */
  .carousel-nav {
    text-align: center;
    margin-top: 5px;
  }

  .nav-dot {
    height: 15px;
    width: 15px;
    background-color: #bbb;
    border-radius: 50%;
    display: inline-block;
    margin: 0 5px;
    cursor: pointer;
  }

  .nav-dot.active {
    background-color: #717171;
  }
</style>
